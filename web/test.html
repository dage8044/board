<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>기상청 날씨 API 연습</title>
    <style>
        table {
            width: 1500px;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            text-align: center;
            border-style: solid;
            border-top: 1px solid #dddddd;
            border-bottom: 1px solid #dddddd;
            border-left: 1px solid #dddddd;
            border-right: 1px solid #dddddd;
        }
        #myDiv {
            padding-bottom: 20px;
        }
        .button-container {
            display: flex;
            justify-content: center;
            margin-top: 20px; 
        }
    </style>
</head>
<body>
    <h1>기상청 날씨</h1>
    <h2 id="region"></h2>
    <div id="myDiv">
        <select id="city-select" onclick="adjustDivStyle()" onchange="onCitySelectChange()">
            <option value="회천3동">=== 선택 ===</option>
            <option value="서울특별시">서울특별시</option>
            <option value="세종특별시">세종특별시</option>
            <option value="부산광역시">부산광역시</option>
            <option value="대구광역시">대구광역시</option>
            <option value="인천광역시">인천광역시</option>
            <option value="광주광역시">광주광역시</option>
            <option value="대전광역시">대전광역시</option>
            <option value="울산광역시">울산광역시</option>
            <option value="경기도">경기도</option>
            <option value="충청북도">충청북도</option>
            <option value="충청남도">충청남도</option>
            <option value="전라북도">전라북도</option>
            <option value="전라남도">전라남도</option>
            <option value="경상북도">경상북도</option>
            <option value="경상남도">경상남도</option>
            <option value="제주도">제주도</option>
            <option value="강원도">강원도</option>
        </select>
    </div>
    <table>
        <thead>
            <tr>
                <th></th>
                <th colspan="18" id="today-date"></th>
                <th colspan="6" id="tomorrow-date"></th>
            </tr>
        </thead>
        <tbody class="result"></tbody>
    </table>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js" integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
    <script>
        var now = new Date();
        var year = now.getFullYear();
        var month = (now.getMonth() + 1).toString().padStart(2, '0');
        var day = now.getDate().toString().padStart(2, '0');
        var base_date = year + month + day;
        var base_time = '0500'; // 기본 시간은 05시로 설정
        var cnt = 1; // 기본 cnt 값은 1로 설정
        var dayday = 1;
        var len = 1;
        var lenlen = 0;
        var city = "회천 3동" // 기본 지역값은 우리동네 ㅎㅎ
        var nx = 61; // 기본 nx 값은 61로 설정
        var ny = 131; // 기본 ny 값은 133로 설정
        document.getElementById('region').textContent = city;
        // 초기 날짜 설정
        var today = getFormattedDateString(now);
        var tomorrow = getFormattedDateString(new Date(year, now.getMonth(), now.getDate() + 1));

        // 날짜 입력
        document.getElementById('today-date').textContent = today;
        document.getElementById('tomorrow-date').textContent = tomorrow;

        // 패딩 설정
        function adjustDivStyle() {
            if (len % 2 === 1) {
                console.log(2)
                var myDiv = document.getElementById("myDiv");
                myDiv.style.paddingBottom = "360px";
                len += 1;
                lenlen += 1
            }else{
                console.log(5)
                lenlen += 1
                len += 1
            }
        }

        // 선택 박스 이외의 영역 클릭 시 패딩 조정이 하고 싶었다...
        window.addEventListener("click", function (event) {
            console.log(1)
            if (lenlen % 2 === 1 && len % 2 === 0){
                console.log(4)
                len += 1
            }
            else{
                console.log(7)
                lenlen += 1
            }
            adjustDivStyle2();
            
        },true);

        // 패딩 설정
        function adjustDivStyle2() {
            var myDiv = document.getElementById("myDiv");
            myDiv.style.paddingBottom = "20px";
        }
        // 콤보박스에서 선택한 도 또는 광역시에 따라 nx, ny 값을 설정하는 함수
        function setNxNy(city) {
            document.getElementById('region').textContent = city;
            switch (city) {
                case '서울특별시':
                    nx = 60;
                    ny = 127;
                    break;
                case '세종특별시':
                    nx = 66;
                    ny = 103;
                    break;
                case '부산광역시':
                    nx = 98;
                    ny = 76;
                    break;
                case '대구광역시':
                    nx = 89;
                    ny = 90;
                    break;
                case '인천광역시':
                    nx = 55;
                    ny = 124;
                    break;
                case '광주광역시':
                    nx = 58;
                    ny = 74;
                    break;
                case '대전광역시':
                    nx = 67;
                    ny = 100;
                    break;
                case '울산광역시':
                    nx = 102;
                    ny = 84;
                    break;
                case '경기도':
                    nx = 60;
                    ny = 120;
                    break;
                case '충청북도':
                    nx = 69;
                    ny = 107;
                    break;
                case '충청남도':
                    nx = 68;
                    ny = 100;
                    break;
                case '전라북도':
                    nx = 63;
                    ny = 89;
                    break;
                case '전라남도':
                    nx = 51;
                    ny = 67;
                    break;
                case '경상북도':
                    nx = 89;
                    ny = 91;
                    break;
                case '경상남도':
                    nx = 91;
                    ny = 77;
                    break;
                case '제주도':
                    nx = 52;
                    ny = 38;
                    break;
                case '강원도':
                    nx = 73;
                    ny = 134;
                    break;
                default:
                    nx = null;
                    ny = null;
                    break;
            }

            return { nx, ny };
        }

        // 콤보박스 선택 변경 시 nx, ny 값을 설정하는 함수
        function onCitySelectChange() {
            var citySelect = document.getElementById('city-select');
            var selectedCity = citySelect.value;

            var { nx, ny } = setNxNy(selectedCity);
            
            if (nx && ny) {
                // nx, ny 값 설정
                base_date = base_date;
                base_time = base_time;
                nx = nx;
                ny = ny;
                cnt = 1; // cnt 초기화

                getWeatherData();
            }
        }

        // API 요청 및 데이터 업데이트
        getWeatherData();

        // 이전 날짜 가져오기
        function getPreviousWeather() {
            var currentDate = new Date(year, month - 1, day);
            currentDate.setDate(currentDate.getDate() - 1);
            year = currentDate.getFullYear();
            month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
            day = currentDate.getDate().toString().padStart(2, '0');
            var previousBaseDate = year + month + day;
            
            cnt = 1
            dayday -= 1
            if (dayday > 1){
                var previousDateString = getFormattedDateString(currentDate);
                document.getElementById('today-date').textContent = previousDateString;
                today = previousDateString;

                tomorrow = getFormattedDateString(new Date(year, currentDate.getMonth(), currentDate.getDate() + 1));
                document.getElementById('tomorrow-date').textContent = tomorrow;
                getWeatherData();
            }else{
                // 날짜 업데이트
                base_date = previousBaseDate;
                var previousDateString = getFormattedDateString(currentDate);
                document.getElementById('today-date').textContent = previousDateString;
                today = previousDateString;

                tomorrow = getFormattedDateString(new Date(year, currentDate.getMonth(), currentDate.getDate() + 1));
                document.getElementById('tomorrow-date').textContent = tomorrow;
                getWeatherData();
            }
            
        }

        // 다음 날짜 가져오기
        function getNextWeather() {
            var currentDate = new Date(year, month - 1, day);
            currentDate.setDate(currentDate.getDate() + 1);
            year = currentDate.getFullYear();
            month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
            day = currentDate.getDate().toString().padStart(2, '0');
            var nextBaseDate = year + month + day;
            dayday += 1
            if (dayday > 1){
                cnt = dayday
                var nextDateString = getFormattedDateString(currentDate);
                document.getElementById('today-date').textContent = nextDateString;
                today = nextDateString;

                tomorrow = getFormattedDateString(new Date(year, currentDate.getMonth(), currentDate.getDate() + 1));
                document.getElementById('tomorrow-date').textContent = tomorrow;

                getWeatherData();
            }else{
                cnt = 1
                // 날짜 업데이트
                var nextDateString = getFormattedDateString(currentDate);
                document.getElementById('today-date').textContent = nextDateString;
                today = nextDateString;

                tomorrow = getFormattedDateString(new Date(year, currentDate.getMonth(), currentDate.getDate() + 1));
                document.getElementById('tomorrow-date').textContent = tomorrow;

                // base_date 업데이트
                base_date = nextBaseDate;

                // 날씨 데이터 요청
                getWeatherData();
            }
        }


        // 표시 날짜 형식 변경
        function getFormattedDateString(date) {
            var month = (date.getMonth() + 1).toString().padStart(2, '0');
            var day = date.getDate().toString().padStart(2, '0');
            var formattedDateString = month + '/' + day;

            return formattedDateString;
        }

        // 날씨 데이터 요청
        function getWeatherData() {
            $.ajax({
                url: 'https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst',
                type: 'GET',
                dataType: 'json',
                data: {
                    serviceKey: decodeURIComponent('wGvp1N3oiF2JaBTqPZZt2X8t6%2FlE8LjMzSKc0I4UpD98tKCnEEzYEajAw5HnBDrzO1y3evtljDkcgT5BG2dNjg%3D%3D'),
                    pageNo: 1,
                    numOfRows: 1000,
                    dataType: 'JSON',
                    base_date: base_date,
                    base_time: base_time,
                    nx: nx,
                    ny: ny
                },
                success: function(data) {
                    console.log(data);
                    updateWeatherData(data);
                },
                error: function(error) {
                    console.error('API 요청 에러:', error);
                }
            });
        }
        // 하늘 상태 분석함수
        function getWeatherStatus(pty, sky) {
            let imagePath = '';

            if (pty === "0") {
                if (sky === "1") {
                    imagePath = 'sunny.png'; // 맑음 이미지 경로
                } else if (sky === "3") {
                    imagePath = 'cloudy.png'; // 구름많음 이미지 경로
                } else if (sky === "4") {
                    imagePath = 'overcast.png'; // 흐림 이미지 경로
                }
            } else {
                if (pty === "1" || pty === "4") {
                    imagePath = 'rain.png'; // 비 이미지 경로
                } else if (pty === "2") {
                    imagePath = 'rain_snow.png'; // 비/눈 이미지 경로
                } else if (pty === "3") {
                    imagePath = 'snow.png'; // 눈 이미지 경로
                }
            }

            return '<img src="' + imagePath + '" alt="">';
        }

        // 데이터 모아서 분석
        function updateWeatherData(data) {
            let items = data.response.body.items.item;
            let categoryData = {
                POP: [], // 강수확률
                REH: [], // 습도
                TMP: [], // 기온
                VEC: [], // 풍향
                WSD: [], // 풍속
            };
            let skyData = {
                PTY: [], // 강수형태
                SKY: [], // 하늘상태
            };
            let category2 = ["강수확률", "습도", "기온", "풍향", "풍속"];
            let timeList = []; // 시간 리스트
            for (let i = 0; i < items.length; i++) {
                let item = items[i];
                let category = item.category;
                let value = item.fcstValue;
                let time = item.fcstTime;

                // 지정된 카테고리만 데이터를 저장
                if (categoryData.hasOwnProperty(category)) {
                    categoryData[category].push(value);
                }
                // 하늘 값들 저장
                if (skyData.hasOwnProperty(category)) {
                    skyData[category].push(value);
                }
                // 시간 값을 저장
                if (!timeList.includes(time)) {
                    timeList.push(time);
                }
            }

            let htmlRows = '';
            let categories = Object.keys(categoryData); // 사용하는 카테고리 리스트
            let sky = Object.keys(skyData);

            htmlRows += '<tr><th>시간</th>'; // 첫 번째 열에 시간 칸 추가

            // 시간 값을 열로 추가
            for (let i = 0; i < timeList.length; i++) {
                let time = timeList[i];
                htmlRows += '<th>' + time + '</th>';
            }

            htmlRows += '</tr>';

            htmlRows += '<tr><th>날씨</th>'; // 두 번째 열에 날씨 칸 추가

            // 하늘 값을 열로 추가
            for (let i = (cnt - 1) * 24; i < cnt * 24; i++) {
                let pty = skyData.PTY[i];
                let sky = skyData.SKY[i];
                let weatherStatus = getWeatherStatus(pty, sky);
                htmlRows += '<th>' + weatherStatus + '</th>';
            }

            for (let i = 0; i < categories.length; i++) {
                let category = categories[i];
                let values = categoryData[category]; // 해당 카테고리의 값 리스트
                htmlRows += '<tr>' +
                    '<th>' + category2[i] + '</th>'; // 카테고리명을 표시하는 열

                // 값 리스트를 HTML에 추가
                for (let j = 0; j < timeList.length; j++) {
                    let time = timeList[j];
                    let value = ''; // 기본값은 빈 문자열

                    // 해당 시간의 값을 찾아서 value에 할당
                    for (let k = (cnt - 1) * 24; k < items.length; k++) {
                        let item = items[k];
                        if (item.category === category && item.fcstTime === time) {
                            value = item.fcstValue;
                            break;
                        }
                    }

                    htmlRows += '<td>' + value + '</td>';
                }

                htmlRows += '</tr>';
            }

            $('.result').html(htmlRows); // HTML에 결과값 적용
        }
    </script>
    <div class="button-container">
        <button onclick="getPreviousWeather()">&lt;</button>
        <button onclick="getNextWeather()">&gt;</button>
    </div>
</body>
</html>
